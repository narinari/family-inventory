# 家族向け持ち物管理システム アーキテクチャ・インフラ設計書

## 改訂履歴

| バージョン | 日付       | 変更内容           |
| ---------- | ---------- | ------------------ |
| v1.0       | 2025-12-26 | 初版作成           |

---

## 1. システム概要

### 1.1 目的

家族で共有する持ち物を管理するシステム。物の所在・所有者・分類を一元管理し、Webブラウザ・Discordの両方からアクセス可能とする。

### 1.2 主要機能

| 機能カテゴリ     | 概要                                           |
| ---------------- | ---------------------------------------------- |
| 持ち物管理       | 登録、検索、ステータス管理（消費/譲渡/売却）   |
| 箱・保管場所管理 | 箱への格納、保管場所の管理                     |
| 購入予定リスト   | 欲しい物の管理、購入完了で持ち物へ連携         |
| ユーザー管理     | 家族メンバーの招待、権限管理                   |
| Discord Bot      | チャットベースでの操作                         |

### 1.3 ユーザー規模

- 家族単位での利用（数名程度）
- 高可用性は不要
- ランニングコスト最小化を重視

---

## 2. 技術スタック

### 2.1 言語・ランタイム

| 項目           | 技術               |
| -------------- | ------------------ |
| 言語           | TypeScript（全レイヤー統一） |
| ランタイム     | Node.js 22         |
| パッケージ管理 | pnpm               |

### 2.2 フロントエンド

| 項目           | 技術               |
| -------------- | ------------------ |
| フレームワーク | Next.js 15 (App Router) |
| スタイリング   | Tailwind CSS 4     |
| 状態管理       | React Server Components + Zustand（必要時） |

### 2.3 バックエンド

| 項目           | 技術               |
| -------------- | ------------------ |
| APIフレームワーク | Hono            |
| バリデーション | Zod                |
| Discord Bot    | discord.js v14     |
| 自然言語処理   | Gemini 2.5 Flash API |

### 2.4 インフラ・データベース

| 項目           | 技術               |
| -------------- | ------------------ |
| クラウド       | Google Cloud Platform (GCP) |
| ホスティング   | Firebase Hosting   |
| API実行環境    | Cloud Run          |
| データベース   | Firestore          |
| 認証           | Firebase Authentication |

---

## 3. アーキテクチャ

### 3.1 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                         GCP                                 │
│                                                             │
│   ┌─────────────────┐         ┌─────────────────┐          │
│   │ Firebase Hosting │         │    Cloud Run    │          │
│   │                 │         │  (Discord Bot)  │          │
│   │    Next.js      │         │   discord.js    │          │
│   │  Tailwind CSS   │         └────────┬────────┘          │
│   └────────┬────────┘                  │                   │
│            │                  ┌────────┴────────┐          │
│            │                  │                 │          │
│            │                  ▼                 ▼          │
│            │         ┌─────────────┐   ┌─────────────┐     │
│            │         │ コマンド形式 │   │  自然言語   │     │
│            │         └──────┬──────┘   └──────┬──────┘     │
│            │                │                 │            │
│            │                │                 ▼            │
│            │                │        ┌─────────────┐       │
│            │                │        │ Gemini API  │       │
│            │                │        │ (2.5 Flash) │       │
│            │                │        └──────┬──────┘       │
│            │                │               │              │
│            ▼                ▼               ▼              │
│   ┌─────────────────────────────────────────────┐          │
│   │              Cloud Run (API)                │          │
│   │                  Hono                       │          │
│   └───────────────────┬─────────────────────────┘          │
│                       │                                     │
│         ┌─────────────┴─────────────┐                      │
│         ▼                           ▼                      │
│   ┌───────────┐              ┌─────────────┐               │
│   │ Firestore │              │  Firebase   │               │
│   │           │              │    Auth     │               │
│   └───────────┘              └─────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘

        ▲                              ▲
        │                              │
┌───────┴───────┐              ┌───────┴───────┐
│  Webブラウザ   │              │    Discord    │
│  (PC/スマホ)   │              │               │
└───────────────┘              └───────────────┘
```

### 3.2 コンポーネント説明

| コンポーネント       | 役割                                   |
| -------------------- | -------------------------------------- |
| Firebase Hosting     | Next.jsで構築した静的サイトを配信      |
| Cloud Run (API)      | Honoで構築したREST APIを提供           |
| Cloud Run (Bot)      | Discord Botを常駐稼働                  |
| Gemini API           | 自然言語の意図解析・応答生成           |
| Firestore            | NoSQLデータベース、全データを永続化    |
| Firebase Auth        | Googleアカウント認証                   |

### 3.3 Discord Bot 処理フロー

```
ユーザーからのメッセージ
         │
         ▼
┌─────────────────┐
│  メッセージ判定  │
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
コマンド形式   自然言語
 (/item等)   (「〇〇どこ？」等)
    │         │
    │         ▼
    │    ┌─────────────┐
    │    │ Gemini API  │
    │    │  意図解析    │
    │    └──────┬──────┘
    │           │
    │           ▼
    │    ┌─────────────┐
    │    │ 操作種別判定 │
    │    │ パラメータ抽出│
    │    └──────┬──────┘
    │           │
    └─────┬─────┘
          ▼
   ┌─────────────┐
   │  API 呼び出し │
   └──────┬──────┘
          ▼
   ┌─────────────┐
   │  応答生成    │
   └──────┬──────┘
          ▼
     Discord へ返信
```

---

## 4. 認証設計

### 4.1 認証方式

- Googleアカウント連携（OAuth 2.0 / OpenID Connect）
- Firebase Authentication を使用

### 4.2 認証フロー

```
┌────────────┐     ┌────────────┐     ┌────────────┐
│   ブラウザ  │     │  Firebase  │     │  Cloud Run │
│  (Next.js) │     │    Auth    │     │   (API)    │
└─────┬──────┘     └─────┬──────┘     └─────┬──────┘
      │                  │                  │
      │ 1. Googleログイン │                  │
      │─────────────────>│                  │
      │                  │                  │
      │ 2. IDトークン返却 │                  │
      │<─────────────────│                  │
      │                  │                  │
      │ 3. APIリクエスト（Authorization: Bearer {token}）
      │─────────────────────────────────────>│
      │                  │                  │
      │                  │ 4. トークン検証   │
      │                  │<─────────────────│
      │                  │─────────────────>│
      │                  │                  │
      │ 5. レスポンス                        │
      │<─────────────────────────────────────│
```

### 4.3 初回登録フロー

```
1. トップページで「Googleでログイン」をクリック
2. Googleアカウントを選択・認証
3. 初回の場合 → 招待コード入力画面へ
4. 招待コードが有効なら → ユーザー登録完了
5. ホーム画面へ

※ 最初のユーザーは招待コード不要で自動的に管理者になる
```

### 4.4 Discord連携フロー

```
1. Web版にGoogleでログイン
2. 設定画面で「Discord連携」をクリック
3. Discord認証画面へリダイレクト
4. 認証完了 → Discord IDがユーザーにひもづく
5. 以降、Discord Botからも操作可能
```

---

## 5. データベース設計（Firestore）

### 5.1 コレクション構造

```
firestore/
├── families/{familyId}                    # 家族（テナント）
│
├── users/{uid}                            # ユーザー
│
├── families/{familyId}/itemTypes/{id}     # アイテム種別
│
├── families/{familyId}/items/{id}         # 持ち物
│
├── families/{familyId}/boxes/{id}         # 箱
│
├── families/{familyId}/locations/{id}     # 保管場所
│
├── families/{familyId}/tags/{id}          # タグ
│
└── families/{familyId}/wishlist/{id}      # 購入予定
```

### 5.2 エンティティ詳細

#### families（家族）

| フィールド   | 型        | 説明               |
| ------------ | --------- | ------------------ |
| name         | string    | 家族名             |
| inviteCode   | string    | 招待コード         |
| createdAt    | timestamp | 作成日時           |

#### users（ユーザー）

| フィールド   | 型        | 説明               |
| ------------ | --------- | ------------------ |
| familyId     | string    | 所属家族ID         |
| name         | string    | 表示名             |
| email        | string    | メールアドレス     |
| photoUrl     | string    | アイコンURL        |
| discordId    | string?   | Discord ID         |
| role         | string    | "admin" / "member" |
| isActive     | boolean   | 有効フラグ         |
| createdAt    | timestamp | 登録日時           |

#### itemTypes（アイテム種別）

| フィールド   | 型        | 説明               |
| ------------ | --------- | ------------------ |
| name         | string    | 種別名             |
| maker        | string?   | メーカー名         |
| description  | string?   | 備考               |
| tags         | string[]  | タグID配列         |
| createdAt    | timestamp | 作成日時           |

#### items（持ち物）

| フィールド   | 型        | 説明                                     |
| ------------ | --------- | ---------------------------------------- |
| itemTypeId   | string    | アイテム種別ID                           |
| ownerId      | string    | 所有者ユーザーID                         |
| status       | string    | "owned" / "consumed" / "given" / "sold"  |
| boxId        | string?   | 格納先箱ID                               |
| tags         | string[]  | タグID配列                               |
| memo         | string?   | メモ                                     |
| purchasedAt  | timestamp? | 購入日時                                |
| consumedAt   | timestamp? | 消費日時                                |
| givenAt      | timestamp? | 譲渡日時                                |
| givenTo      | string?   | 譲渡先                                   |
| soldAt       | timestamp? | 売却日時                                |
| soldTo       | string?   | 売却先                                   |
| soldPrice    | number?   | 売却金額                                 |
| createdAt    | timestamp | 登録日時                                 |

#### boxes（箱）

| フィールド   | 型        | 説明               |
| ------------ | --------- | ------------------ |
| name         | string    | 箱の名前/ラベル    |
| locationId   | string?   | 保管場所ID         |
| description  | string?   | 説明               |
| createdAt    | timestamp | 作成日時           |

#### locations（保管場所）

| フィールド   | 型        | 説明               |
| ------------ | --------- | ------------------ |
| name         | string    | 場所名             |
| address      | string?   | 住所/詳細          |
| createdAt    | timestamp | 作成日時           |

#### tags（タグ）

| フィールド   | 型        | 説明               |
| ------------ | --------- | ------------------ |
| name         | string    | タグ名             |
| createdAt    | timestamp | 作成日時           |

#### wishlist（購入予定）

| フィールド   | 型        | 説明                                      |
| ------------ | --------- | ----------------------------------------- |
| name         | string    | 欲しい物の名前                            |
| itemTypeId   | string?   | 既存アイテム種別ID                        |
| requesterId  | string    | 希望者ユーザーID                          |
| priority     | string    | "high" / "medium" / "low"                 |
| priceRange   | string?   | 希望価格帯                                |
| deadline     | timestamp? | 購入期限                                 |
| url          | string?   | 参考URL                                   |
| tags         | string[]  | タグID配列                                |
| memo         | string?   | メモ                                      |
| status       | string    | "pending" / "purchased" / "cancelled"     |
| createdAt    | timestamp | 登録日時                                  |

---

## 6. API設計

### 6.1 共通仕様

| 項目             | 仕様                              |
| ---------------- | --------------------------------- |
| ベースURL        | `https://api.example.com/v1`      |
| 認証             | Bearer Token（Firebase ID Token） |
| レスポンス形式   | JSON                              |
| 文字コード       | UTF-8                             |

### 6.2 エンドポイント一覧

#### 認証

| メソッド | パス           | 説明                   |
| -------- | -------------- | ---------------------- |
| POST     | /auth/verify   | Firebaseトークン検証   |

#### ユーザー

| メソッド | パス           | 説明                   |
| -------- | -------------- | ---------------------- |
| GET      | /users/me      | 自分の情報取得         |
| PUT      | /users/me      | 自分の情報更新         |
| GET      | /users         | 家族メンバー一覧       |
| POST     | /users/invite  | 招待コード発行         |
| POST     | /users/join    | 招待コードで参加       |

#### アイテム種別

| メソッド | パス              | 説明                   |
| -------- | ----------------- | ---------------------- |
| GET      | /item-types       | 一覧取得               |
| POST     | /item-types       | 新規作成               |
| PUT      | /item-types/:id   | 更新                   |
| DELETE   | /item-types/:id   | 削除                   |

#### 持ち物

| メソッド | パス                 | 説明                   |
| -------- | -------------------- | ---------------------- |
| GET      | /items               | 一覧取得（フィルタ対応） |
| POST     | /items               | 新規登録               |
| PUT      | /items/:id           | 更新                   |
| POST     | /items/:id/consume   | 消費済にする           |
| POST     | /items/:id/give      | 譲渡済にする           |
| POST     | /items/:id/sell      | 売却済にする           |
| GET      | /items/:id/location  | どこにあるか取得       |

#### 箱

| メソッド | パス              | 説明                   |
| -------- | ----------------- | ---------------------- |
| GET      | /boxes            | 一覧取得               |
| POST     | /boxes            | 新規作成               |
| PUT      | /boxes/:id        | 更新                   |
| DELETE   | /boxes/:id        | 削除                   |
| GET      | /boxes/:id/items  | 箱の中身一覧           |

#### 保管場所

| メソッド | パス                 | 説明                   |
| -------- | -------------------- | ---------------------- |
| GET      | /locations           | 一覧取得               |
| POST     | /locations           | 新規作成               |
| PUT      | /locations/:id       | 更新                   |
| DELETE   | /locations/:id       | 削除                   |
| GET      | /locations/:id/boxes | 場所内の箱一覧         |

#### タグ

| メソッド | パス          | 説明                   |
| -------- | ------------- | ---------------------- |
| GET      | /tags         | 一覧取得               |
| POST     | /tags         | 新規作成               |
| DELETE   | /tags/:id     | 削除                   |

#### 購入予定

| メソッド | パス                    | 説明                   |
| -------- | ----------------------- | ---------------------- |
| GET      | /wishlist               | 一覧取得               |
| POST     | /wishlist               | 新規追加               |
| PUT      | /wishlist/:id           | 更新                   |
| POST     | /wishlist/:id/purchase  | 購入完了→持ち物へ      |
| POST     | /wishlist/:id/cancel    | 見送り                 |

---

## 7. Discord Bot 設計

### 7.1 対話方式

| 方式 | 説明 | 例 |
|------|------|-----|
| コマンド形式 | スラッシュコマンドで操作 | `/item add ダウンジャケット` |
| 自然言語 | 日常会話形式で操作 | 「ダウンジャケットどこにある？」 |

両方式を併用可能。自然言語はGemini 2.5 Flash APIで意図解析を行う。

### 7.2 対応チャネル

| チャネル | 動作 |
|----------|------|
| 専用チャンネル | 全メッセージを処理 |
| DM | 全メッセージを処理 |
| その他チャンネル | メンション時のみ処理 |

### 7.3 自然言語で対応する操作

| 操作 | 入力例 |
|------|--------|
| 場所検索 | 「クリスマスツリーどこ？」「乾電池ある？」 |
| 持ち物登録 | 「ウルトラライトダウン買った」 |
| 欲しい物追加 | 「電動ドライバー欲しい」 |
| 購入完了 | 「電動ドライバー届いた」 |
| 消費 | 「乾電池使い切った」 |
| 譲渡 | 「ベビーカーあげた」 |
| 売却 | 「古いスマホ売った」 |
| 一覧表示 | 「冬物の一覧見せて」 |
| 格納先変更 | 「ダウンを冬物ボックスに入れた」 |

### 7.4 コマンド一覧

#### 持ち物操作

| コマンド              | 説明               | 例                              |
| --------------------- | ------------------ | ------------------------------- |
| /item add \<名前\>    | 持ち物を登録       | /item add ウルトラライトダウン  |
| /item list            | 一覧表示           | /item list                      |
| /item search \<条件\> | 検索               | /item search タグ:冬物          |
| /item where \<名前\>  | どこにあるか検索   | /item where クリスマスツリー    |
| /item use \<名前\>    | 消費済にする       | /item use 乾電池                |
| /item give \<名前\>   | 譲渡済にする       | /item give ベビーカー           |
| /item sell \<名前\>   | 売却済にする       | /item sell 古いスマホ           |

#### 購入予定リスト操作

| コマンド                | 説明               | 例                       |
| ----------------------- | ------------------ | ------------------------ |
| /want add \<名前\>      | 欲しい物を追加     | /want add 電動ドライバー |
| /want list              | 一覧表示           | /want list               |
| /want list @ユーザー    | 特定ユーザーの一覧 | /want list @パパ         |
| /want done \<名前\>     | 購入完了にする     | /want done 電動ドライバー|
| /want cancel \<名前\>   | 見送りにする       | /want cancel 電動ドライバー |
| /want detail \<名前\>   | 詳細表示           | /want detail 電動ドライバー |

#### その他操作

| コマンド                | 説明               | 例                       |
| ----------------------- | ------------------ | ------------------------ |
| /box list               | 箱の一覧           | /box list                |
| /box contents \<名前\>  | 箱の中身を表示     | /box contents 冬物ボックス1 |
| /place list             | 保管場所の一覧     | /place list              |
| /help                   | コマンド一覧を表示 | /help                    |

### 7.5 応答例

#### /want list の応答

```
📝 購入予定リスト（3件）

1. 🔴 電動ドライバー
   希望者: パパ ／ 優先度: 高

2. 🟡 子供用自転車
   希望者: ママ ／ 優先度: 中

3. 🟢 LEDランタン
   希望者: パパ ／ 優先度: 低

詳細を見るには /want detail [名前]
```

#### /item where クリスマスツリー の応答

```
🔍 クリスマスツリー の場所

📦 箱: 季節イベント用品ボックス
📍 保管場所: 納戸

所有者: 共有
```

---

## 8. インフラ構成

### 8.1 Cloud Run 設定

| サービス     | メモリ  | 最小インスタンス | 最大インスタンス |
| ------------ | ------- | ---------------- | ---------------- |
| API          | 256 MB  | 0                | 2                |
| Discord Bot  | 256 MB  | 1                | 1                |

### 8.2 Firestore 設定

| 項目         | 設定                |
| ------------ | ------------------- |
| リージョン   | asia-northeast1（東京） |
| モード       | Native mode         |

### 8.3 Firebase Hosting 設定

| 項目         | 設定                |
| ------------ | ------------------- |
| デプロイ方法 | GitHub Actions      |
| キャッシュ   | CDN自動キャッシュ   |

---

## 9. ディレクトリ構成

```
/
├── apps/
│   ├── web/                    # Next.js フロントエンド
│   │   ├── app/
│   │   ├── components/
│   │   ├── lib/
│   │   └── package.json
│   │
│   ├── api/                    # Hono バックエンドAPI
│   │   ├── src/
│   │   │   ├── routes/
│   │   │   ├── services/
│   │   │   ├── middleware/
│   │   │   └── index.ts
│   │   ├── Dockerfile
│   │   └── package.json
│   │
│   └── bot/                    # Discord Bot
│       ├── src/
│       │   ├── commands/
│       │   ├── events/
│       │   └── index.ts
│       ├── Dockerfile
│       └── package.json
│
├── packages/
│   └── shared/                 # 共通の型定義・ユーティリティ
│       ├── src/
│       │   ├── types/
│       │   └── utils/
│       └── package.json
│
├── pnpm-workspace.yaml
├── package.json
└── README.md
```

---

## 10. コスト見積もり

### 10.1 GCP 無料枠

| サービス           | 無料枠                        |
| ------------------ | ----------------------------- |
| Firebase Hosting   | 10 GB/月 転送量               |
| Firebase Auth      | 無制限                        |
| Firestore          | 1 GB ストレージ、5万読取/日   |
| Cloud Run          | 200万リクエスト/月、CPU時間等 |
| Gemini API         | 15 RPM、100万トークン/日      |

### 10.2 月額コスト見積もり

| 項目               | 費用           |
| ------------------ | -------------- |
| Firebase Hosting   | $0（無料枠内） |
| Firebase Auth      | $0             |
| Firestore          | $0（無料枠内） |
| Cloud Run (API)    | $0（無料枠内） |
| Cloud Run (Bot)    | $0〜3          |
| Gemini API         | $0（無料枠内） |
| **合計**           | **$0〜3/月**   |

※ Discord Botは常駐が必要なため、最小インスタンス1で稼働する場合に費用が発生する可能性あり
※ Gemini APIは家族利用（月500リクエスト程度）なら無料枠内で収まる想定

### 10.3 Gemini API 料金詳細（参考）

| モデル | 入力 (per 1M tokens) | 出力 (per 1M tokens) |
|--------|---------------------|---------------------|
| Gemini 2.5 Flash | $0.15 | $0.60 |
| Gemini 2.5 Pro | $1.25 | $5.00 |

本システムでは **Gemini 2.5 Flash** を使用。無料枠を超過した場合でも月$1未満に収まる想定。

---

## 11. 権限設計

### 11.1 ロール定義

| ロール   | 権限                                           |
| -------- | ---------------------------------------------- |
| admin    | すべての操作（ユーザー管理、マスター管理、持ち物管理） |
| member   | 持ち物・箱・保管場所の登録・編集・検索、自分の情報編集 |

### 11.2 補足ルール

| ルール                   | 説明                                       |
| ------------------------ | ------------------------------------------ |
| 管理者は最低1人          | 最後の管理者は役割変更・無効化できない     |
| 他人の持ち物             | 一般メンバーでも編集可（家族内共有のため） |
| 無効化されたユーザー     | ログイン不可だが、持ち物の所有者としては残る |

---

## 12. 今後の検討事項

- 写真添付機能（持ち物・箱の写真）
- QRコード/バーコード対応（箱にラベル貼付）
- 貸し借り管理（家族間での一時貸出）
- 消耗品の在庫数管理
- 廃棄ステータスの追加
- 家族間の譲渡と外部への譲渡の区別
- 通知機能（購入期限が近づいたらBotから通知）

---

## 改訂履歴

| バージョン | 日付       | 変更内容                               |
| ---------- | ---------- | -------------------------------------- |
| v1.0       | 2025-12-26 | 初版作成                               |
| v1.1       | 2025-12-26 | 自然言語対応・Gemini API連携を追加     |
