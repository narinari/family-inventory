rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get current user's UID
    function currentUserId() {
      return request.auth.uid;
    }

    // Get user document
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Get user's familyId
    function getUserFamilyId() {
      return getUserDoc().data.familyId;
    }

    // Get user's role
    function getUserRole() {
      return getUserDoc().data.role;
    }

    // Check if user is a member of the specified family
    function isFamilyMember(familyId) {
      return isAuthenticated() && getUserFamilyId() == familyId;
    }

    // Check if user is an admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    // Check if user is an admin of the specified family
    function isFamilyAdmin(familyId) {
      return isFamilyMember(familyId) && isAdmin();
    }

    // ============================================
    // users collection
    // ============================================
    match /users/{userId} {
      // Read: Authenticated users can read their own data
      // or data of users in the same family
      allow read: if isAuthenticated() && (
        currentUserId() == userId ||
        getUserFamilyId() == resource.data.familyId
      );

      // Create: Can only create own document with required fields
      allow create: if isAuthenticated() &&
        currentUserId() == userId &&
        request.resource.data.keys().hasAll(['email', 'displayName', 'role', 'familyId']) &&
        request.resource.data.role in ['admin', 'member'];

      // Update: Can only update own document
      // Cannot change role or familyId (security)
      allow update: if isAuthenticated() &&
        currentUserId() == userId &&
        request.resource.data.role == resource.data.role &&
        request.resource.data.familyId == resource.data.familyId;

      // Delete: Not allowed (use soft delete or admin-only via backend)
      allow delete: if false;
    }

    // ============================================
    // families collection
    // ============================================
    match /families/{familyId} {
      // Read: Family members only
      allow read: if isFamilyMember(familyId);

      // Create: Authenticated users can create a family
      // Usually done via API server
      allow create: if isAuthenticated() &&
        request.resource.data.keys().hasAll(['name', 'createdBy']) &&
        request.resource.data.createdBy == currentUserId();

      // Update: Admin only
      allow update: if isFamilyAdmin(familyId);

      // Delete: Not allowed
      allow delete: if false;

      // ============================================
      // families/{familyId}/items subcollection
      // ============================================
      match /items/{itemId} {
        allow read: if isFamilyMember(familyId);

        allow create: if isFamilyMember(familyId) &&
          request.resource.data.keys().hasAll(['itemTypeId', 'ownerId', 'status']);

        allow update: if isFamilyMember(familyId);

        allow delete: if isFamilyAdmin(familyId);
      }

      // ============================================
      // families/{familyId}/itemTypes subcollection
      // ============================================
      match /itemTypes/{itemTypeId} {
        allow read: if isFamilyMember(familyId);

        allow create: if isFamilyMember(familyId) &&
          request.resource.data.keys().hasAll(['name']);

        allow update: if isFamilyMember(familyId);

        allow delete: if isFamilyMember(familyId);
      }

      // ============================================
      // families/{familyId}/boxes subcollection
      // ============================================
      match /boxes/{boxId} {
        allow read: if isFamilyMember(familyId);

        allow create: if isFamilyMember(familyId) &&
          request.resource.data.keys().hasAll(['name']);

        allow update: if isFamilyMember(familyId);

        allow delete: if isFamilyAdmin(familyId);
      }

      // ============================================
      // families/{familyId}/locations subcollection
      // ============================================
      match /locations/{locationId} {
        allow read: if isFamilyMember(familyId);

        allow create: if isFamilyMember(familyId) &&
          request.resource.data.keys().hasAll(['name']);

        allow update: if isFamilyMember(familyId);

        allow delete: if isFamilyAdmin(familyId);
      }

      // ============================================
      // families/{familyId}/tags subcollection
      // ============================================
      match /tags/{tagId} {
        allow read: if isFamilyMember(familyId);

        allow create: if isFamilyMember(familyId) &&
          request.resource.data.keys().hasAll(['name']);

        allow update: if isFamilyMember(familyId);

        allow delete: if isFamilyAdmin(familyId);
      }

      // ============================================
      // families/{familyId}/wishlist subcollection
      // ============================================
      match /wishlist/{wishlistId} {
        allow read: if isFamilyMember(familyId);

        allow create: if isFamilyMember(familyId) &&
          request.resource.data.keys().hasAll(['name', 'requesterId', 'priority', 'status']);

        allow update: if isFamilyMember(familyId);

        allow delete: if isFamilyAdmin(familyId);
      }
    }

    // ============================================
    // inviteCodes collection
    // ============================================
    match /inviteCodes/{inviteCodeId} {
      // Read: Authenticated users can read active codes (for validation)
      // or admins can read codes for their family
      allow read: if isAuthenticated() && (
        resource.data.status == 'active' ||
        isFamilyAdmin(resource.data.familyId)
      );

      // Create: Admin only
      allow create: if isFamilyAdmin(request.resource.data.familyId) &&
        request.resource.data.keys().hasAll(['code', 'familyId', 'createdBy', 'status', 'expiresAt']);

      // Update: Only allow marking as used
      allow update: if isAuthenticated() &&
        resource.data.status == 'active' &&
        request.resource.data.status == 'used' &&
        request.resource.data.usedBy == currentUserId();

      // Delete: Not allowed
      allow delete: if false;
    }
  }
}
