# 家族向け持ち物管理システム 要件定義書

## 1. システム概要

家族で共有する持ち物を管理するシステム。物の所在・所有者・分類を一元管理し、Webブラウザ・Discordの両方からアクセス可能とする。

---

## 2. アクセス方式

| 方式 | 説明 |
|------|------|
| Webブラウザ | PC・スマホからブラウザでアクセス。GUI操作 |
| Discord Bot | チャット形式でコマンド操作。手軽に登録・検索 |

---

## 3. 認証方式

| 項目 | 内容 |
|------|------|
| Web版 | Googleアカウント連携（OAuth 2.0 / OpenID Connect） |
| Discord | Discord OAuth連携（Web版ユーザーと紐づけ） |
| 必要スコープ | openid, email, profile |
| 取得情報 | Google ID、メールアドレス、名前、アイコンURL |

### 3.1 招待の仕組み

| 項目 | 説明 |
|------|------|
| 招待コード発行 | 管理者が発行（有効期限付き） |
| 初回ユーザー | 招待コード不要で自動的に管理者になる |
| 家族を追加 | 管理者が招待コードを共有 → 家族がGoogleログイン時に入力 |

### 3.2 認証フロー

#### Web版：初回利用

1. トップページで「Googleでログイン」をクリック
2. Googleアカウントを選択・認証
3. 初回の場合 → 招待コード入力画面へ
4. 招待コードが有効なら → ユーザー登録完了
5. ホーム画面へ

#### Web版：2回目以降

1. 「Googleでログイン」をクリック
2. Googleアカウントを選択・認証
3. ホーム画面へ

#### Discord連携

1. Web版にGoogleでログイン
2. 設定画面で「Discord連携」をクリック
3. Discord認証画面へリダイレクト
4. 認証完了 → Discord IDがユーザーに紐づく
5. 以降、Discord Botからも操作可能

---

## 4. エンティティ設計

### 4.1 ユーザー（家族メンバー）

| 属性 | 説明 | 必須 |
|------|------|------|
| ID | 一意識別子 | ○ |
| 名前 | 表示名 | ○ |
| Google ID | Google認証用の識別子 | ○ |
| メールアドレス | Googleアカウントのメール | ○ |
| Discord ID | Discord連携用 | |
| 役割 | 管理者 / 一般メンバー | ○ |
| アイコン | プロフィール画像（Google画像を初期値） | |
| 登録日時 | 登録タイムスタンプ | ○ |
| 有効フラグ | アカウント有効/無効 | ○ |

### 4.2 アイテム種別（マスター）

| 属性 | 説明 | 必須 |
|------|------|------|
| ID | 一意識別子 | ○ |
| 名称 | 物の種類名 | ○ |
| メーカー名 | 製造元・ブランド名 | |
| 説明 | 製品の一般的な説明 | |
| 備考 | その他メモ（型番、参考URLなど） | |
| タグ | 分類用タグ（複数可） | |

### 4.3 持ち物（個別実体）

| 属性 | 説明 | 必須 |
|------|------|------|
| ID | 一意識別子 | ○ |
| アイテム種別ID | どの種類の物か | ○ |
| 所有者 | 誰の物か（デフォルト：登録操作者） | ○ |
| ステータス | 所有中 / 消費済 / 譲渡済 / 売却済 | ○ |
| 購入日時 | いつ購入（入手）したか | |
| 消費日時 | いつ消費したか | |
| 譲渡日時 | いつ譲渡したか | |
| 売却日時 | いつ売却したか | |
| 譲渡先/売却先 | 誰に渡したか | |
| 売却金額 | いくらで売ったか | |
| 格納先 | 箱ID または null | |
| タグ | 分類用タグ（複数可） | |
| メモ | 個別の備考 | |
| 登録日時 | 登録タイムスタンプ | ○ |

### 4.4 箱

| 属性 | 説明 | 必須 |
|------|------|------|
| ID | 一意識別子 | ○ |
| 名前/ラベル | 箱の識別名 | ○ |
| 保管場所ID | どこに置いてあるか | |
| 説明 | 補足情報 | |

### 4.5 保管場所

| 属性 | 説明 | 必須 |
|------|------|------|
| ID | 一意識別子 | ○ |
| 名称 | 場所名（例：納戸、トランクルームA） | ○ |
| 住所/詳細 | 場所の詳細情報 | |

### 4.6 タグ

| 属性 | 説明 | 必須 |
|------|------|------|
| ID | 一意識別子 | ○ |
| 名称 | タグ名 | ○ |

### 4.7 購入予定（ほしいものリスト）

| 属性 | 説明 | 必須 |
|------|------|------|
| ID | 一意識別子 | ○ |
| 名称 | 欲しい物の名前 | ○ |
| アイテム種別ID | 既存種別があれば紐づけ | |
| 希望者 | 誰が欲しいか | ○ |
| 優先度 | 高 / 中 / 低 | ○ |
| 希望価格帯 | 予算の目安 | |
| 購入期限 | いつまでに欲しいか | |
| 参考URL | 商品ページのリンク等 | |
| タグ | 分類用タグ（複数可） | |
| メモ | 補足情報 | |
| ステータス | 検討中 / 購入済 / 見送り | ○ |
| 登録日時 | 登録タイムスタンプ | ○ |

---

## 5. エンティティ関連図

```
┌─────────────┐
│   ユーザー   │ ← 家族メンバー
└──────┬──────┘
       │ 所有 / 希望
       ▼
┌─────────────┐      参照      ┌─────────────┐
│   持ち物     │─────────────→│ アイテム種別 │
│ (個別実体)   │              │  (マスター)  │
└──────┬──────┘              └──────┬──────┘
       │ 格納                        │ 付与
       ▼                            ▼
┌─────────────┐              ┌─────────────┐
│     箱      │              │    タグ     │
└──────┬──────┘              └─────────────┘
       │ 保管                        ▲
       ▼                            │ 付与
┌─────────────┐              ┌─────────────┐
│   保管場所   │              │   持ち物     │
└─────────────┘              └─────────────┘

┌─────────────┐      参照      ┌─────────────┐
│  購入予定    │─────────────→│ アイテム種別 │
└─────────────┘              └─────────────┘
```

---

## 6. タグの使い分け

| 対象 | タグの用途 | 例 |
|------|-----------|-----|
| アイテム種別 | 製品カテゴリ・一般的な分類 | 衣類、季節物、アウトドア |
| 持ち物 | 個別の属性・状態 | Mサイズ、ネイビー、要修理、貸出中 |

検索時はアイテム種別のタグ＋持ち物のタグの両方で絞り込み可能。

---

## 7. 持ち物のライフサイクル

```
【購入予定】                  【持ち物】
    │                           │
    │ 購入                      │
    └──────→ 所有中 ────────────┤
                                │
              ┌─────────────────┼─────────────────┐
              ▼                 ▼                 ▼
           消費済            譲渡済            売却済
         （使い切り）      （人にあげた）    （売った）
```

---

## 8. 機能要件

### 8.1 持ち物管理

| 機能 | 説明 |
|------|------|
| 登録 | 持ち物を登録。所有者はデフォルト＝操作者、変更可 |
| 所有者変更 | 登録後も所有者を変更可能 |
| 格納先設定 | どの箱に入れたかを記録 |
| 検索 | 名称・タグ・所有者・保管場所などで検索 |
| 一覧表示 | 条件付きで持ち物リストを表示 |

### 8.2 持ち物ステータス管理

| 機能 | 説明 |
|------|------|
| 消費登録 | 持ち物を「消費済」にし、消費日時を記録 |
| 譲渡登録 | 持ち物を「譲渡済」にし、譲渡日時・譲渡先を記録 |
| 売却登録 | 持ち物を「売却済」にし、売却日時・売却先・金額を記録 |
| 履歴表示 | 過去に消費/譲渡/売却した持ち物を一覧表示 |

### 8.3 マスター管理

| 機能 | 説明 |
|------|------|
| アイテム種別の登録・編集 | 物の種類をマスター管理 |
| タグの登録・編集 | 分類用タグを管理 |
| 箱の登録・編集 | 箱を管理 |
| 保管場所の登録・編集 | 納戸・トランクルーム等を管理 |

### 8.4 探索支援

| 機能 | 説明 |
|------|------|
| 「○○はどこ？」 | 持ち物 → 箱 → 保管場所 の経路を表示 |
| 「この箱の中身は？」 | 箱に入っている持ち物一覧 |
| 「この場所にある箱は？」 | 保管場所内の箱一覧 |

### 8.5 ユーザー管理

| 機能 | 説明 | 実行可能者 |
|------|------|-----------|
| ユーザー登録 | 新しい家族メンバーを追加 | 管理者 |
| ユーザー編集 | 名前・連絡先等の変更 | 本人 / 管理者 |
| ユーザー無効化 | アカウントを無効にする（論理削除） | 管理者 |
| ユーザー一覧 | 家族メンバー一覧を表示 | 全員 |
| 役割変更 | 管理者 ↔ 一般メンバーの切り替え | 管理者 |
| Discord連携 | DiscordアカウントとユーザーをひもづけまたはDiscordアカウントから新規ユーザー登録 | 本人 / 管理者 |

### 8.6 購入予定リスト管理

| 機能 | 説明 |
|------|------|
| 登録 | 欲しい物を登録 |
| 編集 | 内容の更新 |
| 購入完了 | 購入済にして、持ち物として登録（連携） |
| 見送り | 購入しないことを記録 |
| 一覧・検索 | 希望者・優先度・タグ等で絞り込み |

### 8.7 購入予定 → 持ち物 への連携

1. 購入予定リストから「購入完了」を実行
2. 自動的に持ち物として登録
   - アイテム種別：紐づけ済みならそのまま、なければ新規作成
   - 所有者：希望者がデフォルト
   - 購入日時：今日がデフォルト
3. 購入予定のステータスを「購入済」に変更

---

## 9. 権限設計

| 役割 | できること |
|------|-----------|
| 管理者 | すべての操作（ユーザー管理、マスター管理、持ち物管理） |
| 一般メンバー | 持ち物・箱・保管場所の登録・編集・検索、自分の情報の編集 |

### 補足ルール

| ルール | 説明 |
|--------|------|
| 管理者は最低1人 | 最後の管理者は役割変更・無効化できない |
| 他人の持ち物 | 一般メンバーでも編集可（家族内共有のため） |
| 無効化されたユーザー | ログイン不可だが、持ち物の所有者としては残る |

---

## 10. Discord Bot 設計

### 10.1 対話方式

| 項目 | 内容 |
|------|------|
| 対話方式 | 自然言語 + コマンド形式（併用） |
| 対応チャネル | 専用チャンネル / DM（両方対応） |
| LLM連携 | Claude API 等を使用して自然言語を解釈 |

### 10.2 自然言語での操作例

| 機能 | ユーザー発話例 |
|------|---------------|
| 持ち物の場所検索 | 「クリスマスツリーどこ？」「扇風機探して」 |
| 持ち物の登録 | 「電動ドライバー買った」「自転車もらった」 |
| 欲しい物の追加 | 「テント欲しい」「新しい掃除機が必要」 |
| 購入完了 | 「テント届いた」「ドライバー買ってきた」 |
| 消費 | 「乾電池使い切った」「シャンプーなくなった」 |
| 譲渡 | 「ベビーカー友達にあげた」 |
| 売却 | 「古いスマホメルカリで売った」 |
| 一覧表示 | 「欲しい物リスト見せて」「冬物ボックスの中身教えて」 |
| 格納先変更 | 「ダウン、冬物ボックスに入れた」 |

### 10.3 会話フロー例

#### 欲しい物リストへの追加

```
👤 ユーザー: 最近キャンプ始めたんだけど、テントが欲しいんだよね

🤖 Bot: テントを欲しい物リストに追加しますか？

👤 ユーザー: うん、お願い

🤖 Bot: 追加しました！
        📝 テント
        希望者: パパ ／ 優先度: 中
        優先度や詳細を変更したい場合はお知らせください。
```

#### 購入完了 → 持ち物登録 → 格納先設定

```
👤 ユーザー: 先週買った電動ドライバー、届いたよ

🤖 Bot: 電動ドライバーを購入完了にして、持ち物に登録しますね。
        所有者はパパ、購入日は今日でよいですか？

👤 ユーザー: うん、あと工具箱に入れておいた

🤖 Bot: 了解です。格納先を「工具箱」に設定しました。
        📦 電動ドライバー → 工具箱（ガレージ）
```

#### 場所の問い合わせ

```
👤 ユーザー: クリスマスツリーってどこにしまったっけ？

🤖 Bot: クリスマスツリーは「季節イベント用品ボックス」に入っていて、
        納戸に保管されています。
```

### 10.4 コマンド形式（従来方式）

コマンド形式も引き続き使用可能です。

#### 購入予定リスト操作

| コマンド | 説明 | 例 |
|----------|------|-----|
| /want add | 欲しい物を追加 | /want add 電動ドライバー |
| /want list | 一覧表示 | /want list |
| /want list @ユーザー | 特定ユーザーの一覧 | /want list @パパ |
| /want done | 購入完了にする | /want done 電動ドライバー |
| /want cancel | 見送りにする | /want cancel 電動ドライバー |
| /want detail | 詳細表示 | /want detail 電動ドライバー |

### 10.5 持ち物操作コマンド

| コマンド | 説明 | 例 |
|----------|------|-----|
| /item add | 持ち物を登録 | /item add ウルトラライトダウン |
| /item list | 一覧表示 | /item list |
| /item search | 検索 | /item search タグ:冬物 |
| /item where | どこにあるか検索 | /item where クリスマスツリー |
| /item use | 消費済にする | /item use 乾電池 |
| /item give | 譲渡済にする | /item give ベビーカー |
| /item sell | 売却済にする | /item sell 古いスマホ |

### 10.6 その他コマンド

| コマンド | 説明 | 例 |
|----------|------|-----|
| /box list | 箱の一覧 | /box list |
| /box contents | 箱の中身を表示 | /box contents 冬物ボックス1 |
| /place list | 保管場所の一覧 | /place list |
| /help | コマンド一覧を表示 | /help |

### 10.7 コマンド応答イメージ

#### /want list の応答例

```
📝 購入予定リスト（3件）

1. 🔴 電動ドライバー
   希望者: パパ ／ 優先度: 高

2. 🟡 子供用自転車
   希望者: ママ ／ 優先度: 中

3. 🟢 LEDランタン
   希望者: パパ ／ 優先度: 低

詳細を見るには /want detail [名前]
```

#### /item where クリスマスツリー の応答例

```
🔍 クリスマスツリー の場所

📦 箱: 季節イベント用品ボックス
📍 保管場所: 納戸

所有者: 共有
```

---

## 11. 非機能要件

| 項目 | 要件 |
|------|------|
| 認証 | 家族メンバーのみアクセス可（Google OAuth / Discord OAuth連携） |
| データ永続化 | データベースで永続化 |
| レスポンス | Discord Botは3秒以内に応答 |
| 可用性 | 個人利用のため高可用性は不要 |

---

## 12. 今後検討事項

- 写真添付機能（持ち物・箱の写真）
- QRコード/バーコード対応（箱にラベル貼付）
- 貸し借り管理（家族間での一時貸出）
- 消耗品の在庫数管理
- 廃棄ステータスの追加
- 家族間の譲渡と外部への譲渡の区別
- 通知機能（購入期限が近づいたらBotから通知）

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1 | - | 初版作成 |
| v2 | - | 持ち物にタグを追加 |
| v3 | - | ユーザー管理機能を追加 |
| v4 | - | 認証方式をGoogleアカウント連携に決定 |
| v5 | - | 持ち物ステータス・購入予定リストを追加 |
| v6 | - | Discord Botコマンド設計を追加 |
| v7 | - | 自然言語対応を追加（コマンドと併用、専用チャンネル/DM両対応） |
